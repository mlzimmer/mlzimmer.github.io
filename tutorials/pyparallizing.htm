<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:"Calibri Light";
	panose-1:2 15 3 2 2 2 4 3 2 4;}
@font-face
	{font-family:inherit;
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:Consolas;
	panose-1:2 11 6 9 2 2 4 3 2 4;}
@font-face
	{font-family:"JetBrains Mono";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:8.0pt;
	margin-left:0in;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
h1
	{mso-style-link:"Heading 1 Char";
	margin-right:0in;
	margin-left:0in;
	font-size:24.0pt;
	font-family:"Times New Roman",serif;
	font-weight:bold;}
h2
	{mso-style-link:"Heading 2 Char";
	margin-top:2.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	line-height:107%;
	page-break-after:avoid;
	font-size:13.0pt;
	font-family:"Calibri Light",sans-serif;
	color:#2F5496;
	font-weight:normal;}
h3
	{mso-style-link:"Heading 3 Char";
	margin-top:2.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	line-height:107%;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:"Calibri Light",sans-serif;
	color:#1F3763;
	font-weight:normal;}
p.MsoHeader, li.MsoHeader, div.MsoHeader
	{mso-style-link:"Header Char";
	margin:0in;
	margin-bottom:.0001pt;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{mso-style-link:"Footer Char";
	margin:0in;
	margin-bottom:.0001pt;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoTitle, li.MsoTitle, div.MsoTitle
	{mso-style-link:"Title Char";
	margin:0in;
	margin-bottom:.0001pt;
	font-size:28.0pt;
	font-family:"Calibri Light",sans-serif;
	letter-spacing:-.5pt;}
p.MsoTitleCxSpFirst, li.MsoTitleCxSpFirst, div.MsoTitleCxSpFirst
	{mso-style-link:"Title Char";
	margin:0in;
	margin-bottom:.0001pt;
	font-size:28.0pt;
	font-family:"Calibri Light",sans-serif;
	letter-spacing:-.5pt;}
p.MsoTitleCxSpMiddle, li.MsoTitleCxSpMiddle, div.MsoTitleCxSpMiddle
	{mso-style-link:"Title Char";
	margin:0in;
	margin-bottom:.0001pt;
	font-size:28.0pt;
	font-family:"Calibri Light",sans-serif;
	letter-spacing:-.5pt;}
p.MsoTitleCxSpLast, li.MsoTitleCxSpLast, div.MsoTitleCxSpLast
	{mso-style-link:"Title Char";
	margin:0in;
	margin-bottom:.0001pt;
	font-size:28.0pt;
	font-family:"Calibri Light",sans-serif;
	letter-spacing:-.5pt;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;}
p.MsoPlainText, li.MsoPlainText, div.MsoPlainText
	{mso-style-link:"Plain Text Char";
	margin:0in;
	margin-bottom:.0001pt;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p
	{margin-right:0in;
	margin-left:0in;
	font-size:12.0pt;
	font-family:"Times New Roman",serif;}
code
	{font-family:"Courier New";}
pre
	{mso-style-link:"HTML Preformatted Char";
	margin:0in;
	margin-bottom:.0001pt;
	font-size:10.0pt;
	font-family:"Courier New";}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:8.0pt;
	margin-left:.5in;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpFirst, li.MsoListParagraphCxSpFirst, div.MsoListParagraphCxSpFirst
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpMiddle, li.MsoListParagraphCxSpMiddle, div.MsoListParagraphCxSpMiddle
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpLast, li.MsoListParagraphCxSpLast, div.MsoListParagraphCxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:8.0pt;
	margin-left:.5in;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
span.MsoBookTitle
	{letter-spacing:.25pt;
	font-weight:bold;
	font-style:italic;}
span.Heading1Char
	{mso-style-name:"Heading 1 Char";
	mso-style-link:"Heading 1";
	font-family:"Times New Roman",serif;
	font-weight:bold;}
p.msonormal0, li.msonormal0, div.msonormal0
	{mso-style-name:msonormal;
	margin-right:0in;
	margin-left:0in;
	font-size:12.0pt;
	font-family:"Times New Roman",serif;}
span.pre
	{mso-style-name:pre;}
span.sig-paren
	{mso-style-name:sig-paren;}
p.first, li.first, div.first
	{mso-style-name:first;
	margin-right:0in;
	margin-left:0in;
	font-size:12.0pt;
	font-family:"Times New Roman",serif;}
span.HTMLPreformattedChar
	{mso-style-name:"HTML Preformatted Char";
	mso-style-link:"HTML Preformatted";
	font-family:"Courier New";}
span.p
	{mso-style-name:p;}
span.s1
	{mso-style-name:s1;}
span.n
	{mso-style-name:n;}
span.o
	{mso-style-name:o;}
span.kc
	{mso-style-name:kc;}
span.mf
	{mso-style-name:mf;}
span.mi
	{mso-style-name:mi;}
p.rubric, li.rubric, div.rubric
	{mso-style-name:rubric;
	margin-right:0in;
	margin-left:0in;
	font-size:12.0pt;
	font-family:"Times New Roman",serif;}
span.gp
	{mso-style-name:gp;}
span.kn
	{mso-style-name:kn;}
span.nn
	{mso-style-name:nn;}
span.k
	{mso-style-name:k;}
span.go
	{mso-style-name:go;}
span.nb
	{mso-style-name:nb;}
span.Heading2Char
	{mso-style-name:"Heading 2 Char";
	mso-style-link:"Heading 2";
	font-family:"Calibri Light",sans-serif;
	color:#2F5496;}
span.Heading3Char
	{mso-style-name:"Heading 3 Char";
	mso-style-link:"Heading 3";
	font-family:"Calibri Light",sans-serif;
	color:#1F3763;}
span.doc
	{mso-style-name:doc;}
p.last, li.last, div.last
	{mso-style-name:last;
	margin-right:0in;
	margin-left:0in;
	font-size:12.0pt;
	font-family:"Times New Roman",serif;}
span.s2
	{mso-style-name:s2;}
p.BoxedCode, li.BoxedCode, div.BoxedCode
	{mso-style-name:BoxedCode;
	mso-style-link:"BoxedCode Char";
	margin:0in;
	margin-bottom:.0001pt;
	line-height:107%;
	background:#F9F9F9;
	border:none;
	padding:0in;
	font-size:9.0pt;
	font-family:"Courier New";
	color:black;}
span.BoxedCodeChar
	{mso-style-name:"BoxedCode Char";
	mso-style-link:BoxedCode;
	font-family:"Courier New";
	color:black;
	background:#F9F9F9;}
span.hljs-comment
	{mso-style-name:hljs-comment;}
span.hljs-parameter
	{mso-style-name:hljs-parameter;}
span.hljs-variable
	{mso-style-name:hljs-variable;}
span.hljs-string
	{mso-style-name:hljs-string;}
span.hljs-pscommand
	{mso-style-name:hljs-pscommand;}
span.PlainTextChar
	{mso-style-name:"Plain Text Char";
	mso-style-link:"Plain Text";
	font-family:"Calibri",sans-serif;}
span.HeaderChar
	{mso-style-name:"Header Char";
	mso-style-link:Header;}
span.FooterChar
	{mso-style-name:"Footer Char";
	mso-style-link:Footer;}
span.TitleChar
	{mso-style-name:"Title Char";
	mso-style-link:Title;
	font-family:"Calibri Light",sans-serif;
	letter-spacing:-.5pt;}
span.kwd
	{mso-style-name:kwd;}
span.pln
	{mso-style-name:pln;}
span.pun
	{mso-style-name:pun;}
span.com
	{mso-style-name:com;}
span.lit
	{mso-style-name:lit;}
span.str
	{mso-style-name:str;}
span.typ
	{mso-style-name:typ;}
.MsoChpDefault
	{font-family:"Calibri",sans-serif;}
.MsoPapDefault
	{margin-bottom:8.0pt;
	line-height:107%;}
 /* Page Definitions */
 @page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>

</head>

<body lang=EN-US link=blue vlink=purple>

<div class=WordSection1>

<p class=MsoTitle>Parallelizing of ML Hyperparameter Tuning with Ad-hoc SSH
Clusters</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Friday, May 29, 2020</p>

<p class=MsoNormal>The development of an AI DNN model requires specifying
numerous parameters and options, known as hyperparameters, involved in compiling
and fitting the DNN model. The AI DNN is based on hyperparameters which defines
the NN model and training. A typical set of hyperparameters for NN include the
number and size of the hidden layers, weight initialization scheme, learning
rate and its decay, dropout and gradient clipping threshold, etc. A further
distinction occurs when considering data and how the model is trained. The DNN
model learns through the training process (e.g., based on the NN graph it
defines the weights) and although in theory could be set beforehand, it is
still guesswork<i>.</i></p>

<p class=MsoNormal>The quality of that DNN model depends on selecting the best
or &quot;optimal&quot; hyperparameters. Thus, tuning the hyperparameters to
achieve the best DNN model is an important as well as time consuming element in
ML software development. Since there are numerous combinations of
hyperparameters and of DNN modeling strategies, using a computational strategy
is very appealing. For example, the scikit learn Python software package has a
GridSearchCV that does an optimization on function using a grid of potential
hypervariable selections. GridSearchCV does an exhaustive search over specified
grid of hypervariable for an estimator, in our case a machine learning model.
If you assume 10 different hyperparameter, each with 10 different potential
variables, then you have 100 different combinations of hyperparameters. If each
ML train/test estimation evaluation takes 1 hour, the total evaluation time on
one computer would take 100 hours or over 4 days. If you could use a cluster of
100 different PC computer and parallelize the search operation it could take 1
hour, plus the time to coordinate and synchronize the parallelization
operation. Thus, in the simple example reducing the train/test/evaluate time
from 4 days to an hour illustrates the appeal of parallelizing the
hyperparameter grid  search. </p>

<p class=MsoNormal>Since hyperparameter tuning is computationally intensive,
the need to find ways to scale the computations across multiple machines is
useful. As the need to perform computations across multiple machines is not
inherently supported in most programming paradigms, this introduces many new programming
concerns. First, the computers must communicate across a network. Scheduling of
parallel execution, and synchronization of results must be available for the
programmer. Specifying the scheduling and cluster of computers to communicate
with and perform computation must be available.  Other features like handling
errors, cloud deployment and supporting a variety of existing parallel HPC tools
are important considerations in parallel computing. </p>

<p class=MsoNormal>This tutorial covers hyperparameter tuning in a parallel
ad-hoc network of computers using a variety of Python tools, some that work on
a single computer, or a cluster of computers using SSH, or an HPC found at NIST
(Enki) using SLURM described <a
href="https://www.nist.gov/programs-projects/computation-platform-aiml">here</a>. 
GridSearchCV uses joblib as a parallelization mechanism on a single board CPU
but which can be generatlized to a CPU cluster. More on joblib parallel
mechanism can be found  <a
href="https://joblib.readthedocs.io/en/latest/parallel.html">here</a>. </p>

<p class=MsoNormal>&nbsp;</p>

<h1>Installation</h1>

<p class=MsoNormal>This sections covers general installation of the Python essential
components in the AI/ML ad-hoc cluster.</p>

<h2>Keras Python ML Environment</h2>

<p class=MsoNormal>A clean installation on a Linux machine will be presented.
Bash shell scrips were written to load an Anaconda Python environment, create a
Conda environment, and then load all the ML Python packages required in the
(non-GPU) deployment of TensorFlow  and Keras. This script is</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>#!/bin/bash</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>#Install
anaconda3</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt; cd
/tmp</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt; curl
-O https://repo.anaconda.com/archive/Anaconda3-2019.03-Linux-x86_64.sh</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt; bash
Anaconda3-2019.03-Linux-x86_64.sh</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>**<b>
INSTALL INTO /usr/local/anaconda3</b> on every Linux Box**</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># This
doesn't seem to work?</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
source ~/.bashrc</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Create
a new anaconda3 python environment</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda create --name py37 python=3.6.10</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Activate
the new anaconda3 python environment</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
source activate py37</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># install
the required ML packages:</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda install -y pandas </p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda install -y numpy</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda install -y matplotlib</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda install -y scikit-learn</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda install -y tensorflow </p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt; conda
install -y pyyaml</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda install -y lxml</p>

</div>

<p class=MsoNormal>Of note, while you are installing anaconda3, it is best to <b>INSTALL
INTO /usr/local/anaconda3</b> on every Linux Box that you want in the cluster.
By default, anaconda will install in your home directory ~/anaconda3, which for
NIST domain has a division folder under the home directory. IN general, Ubuntu has
/home/user as the home directory. So, you can have competing home directories (e.g.,
/home/isd/michalos versus /home/michalos) to contend with. To alleviate this
home folder problem, all anaconda installations and virtual environments were
under the /usr/local/anaconda3 or /usr/local/user folders across all cluster
Linux boxes. However, using /usr/local as a directory root can cause
administrative privileges issues when creating a directory. To mitigate this circumstance,
sudo was used to run the Anaconda installation bash shell, and then sudo was
used to recursively change the owner of all the files to myself. Yes, a real
headache.</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>sudo
chown -R michalos</p>

</div>

<p class=MsoNormal>To install Anaconda we first use curl to download the
Anaconda installation shell into the /tmp directory, and then use the anaconda
3 install shell as described <a
href="https://www.digitalocean.com/community/tutorials/how-to-install-anaconda-on-ubuntu-18-04-quickstart">here</a>:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>#Install
anaconda3</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt; cd
/tmp</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt; curl
-O https://repo.anaconda.com/archive/Anaconda3-2019.03-Linux-x86_64.sh</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt; bash
Anaconda3-2019.03-Linux-x86_64.sh</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

</div>

<p class=MsoNormal>Anaconda will ask for license agreement and then for
installation folder, which /usr/local/anaconda3 was used, with the rationale
provided previously. During the anaconda3 installation the. bashrc terminal
script is modified to add conda bin directory to the path. Upon future terminal
deployment, the conda binary will be found, however, to do this in the script
we need to source the. bashrc:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># This
doesn't seem to work?</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
source ~/.bashrc</p>

</div>

<p class=MsoNormal>(Not absolutely positive this works, may need to export the
modified PATH environment variable after its modified.) Assuming conda binary
is in the path, we create an Python environment with a 3.6 Python interpreter,
that will be used to program Keras ML models:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Create
a new anaconda3 python environment</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda create --name py37 python=3.7.7</p>

</div>

<p class=MsoNormal>We then activate this anaconda environment:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>#
Activate the new anaconda3 python environment</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
source activate py37</p>

</div>

<p class=MsoNormal>And load the required Python packages are loaded using conda
install as the installation. Not the -y is used to silently accept the
installation.</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># install
the required ML packages:</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda install -y pandas </p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda install -y numpy</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda install -y matplotlib</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda install -y scikit-learn</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda install -y tensorflow</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda install -y pyyaml</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;
conda install -y lxml</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt; conda
install -y mathutil</p>

</div>

<p class=MsoNormal>Of note, the lxml and the pyyaml Python packages are for the
ROS URDFDom python parsing package, which is used to load the kinematic model
of the robot for which ML models are to be deployed. </p>

<p class=MsoNormal>The Python install of mathutil is for a math package
containing support for quaternion, matrix, and vector from Blender. It can be
tricky finding the package with conda but installs and works.</p>

<p class=MsoNormal>&nbsp;</p>

<h2>Installing SSH</h2>

<p class=MsoNormal>The initial deployment intended goal was an ad-hoc network
of PCs based on SSH implementation described <a href="https://www.openssh.com/">here</a>.
SSH itself is a software package to enable secure system over insecure networks.
SSH is based on a client-server architecture where the host system the user is
working on is the client and the remote system being managed is the server. SSH
itself has several communication layers but of interest will only be the user
authentication layer which handles the authentication and communication of a
user between a SSH client and a SSH server.  SSH user authentication is based
on a traditional password authentication as well as public-key or host-based
authentication mechanisms.  It is common for ad-hoc SSH clusters to use SSH
keys to automate access to parallel workers (i.e., SSH servers).</p>

<p class=MsoNormal>For the Linux deployment, OpenSSH sponsored by the IETF is
the SSH tool set used. More documentation on OpenSSH can be found <a
href="https://www.openssh.com/">here</a>. We will discuss deployment on Ubuntu
a Debian OS. Further a command line interface is used to execute the SSH
command sequence. Assuming the Linux user has sudo rights, apt is used to
install OpenSSH, and then the Ubuntu firewall port 22 is opened so that SSH can
communicate through it, shown below.</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>sudo apt
install openssh-server</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># open firewall
port 22 for ssh</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>sudo ufw
allow ssh</p>

</div>

<p>Next, SSH keys are created and used to enable authentication and
communication to a remote (and local) host. The local host is used as the head
or master scheduler, so SSH need to be implemented so that the user can
seamlessly authenticate with the localhost. First, we create a public and
private set of RSA keys for use in authentication. This should be done on the
client.</p>

<p>Code shown below is based on documentation found <a
href="https://help.ubuntu.com/community/SSH/OpenSSH/Keys">here</a>. To create
your public and private SSH keys on the command-line:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>mkdir ~/.ssh</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>chmod 700
~/.ssh</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>ssh-keygen
-t rsa</p>

</div>

<p>Then the public key is copied to all the remote SSH hosts so that the client
SSH can seamlessly authenticate and then communicate. Each remote SSH host is a
&quot;worker&quot;. To enable seamless authentication, the OpenSSH command ssh-copy-id
is used to copy the public SSH key to the remote host, then an SSH login is
done which will be required authentication with the SSH key passphrase. First,
the localhost SSH communication is authenticated for user &quot;michalos&quot;:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># copy
public key to SSH server listening on port 22<br>
&gt; ssh-copy-id michalos@localhost<br>
# Make sure password accepted </p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt; ssh
michalos@localhost</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># This
time it should not require password authenication<br>
&gt; ssh michalos@localhost</p>

</div>

<p class=MsoNormal>Next the remote host &quot;onyx&quot; is SSH enabled:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Copy
public key to SSH server on onyx<br>
ssh-copy-id michalos@onyx<br>
ssh michalos@onyx</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Remember, initially the SSH client asks for a password to
authenticate, which corresponds to the passphrase, not the logon password.</p>

<p class=MsoNormal>Note, the id_rsa private key must have r/w permission ONLY
for me the owner. Changed to see pop up dialog in Linux asking for password
would go away, assumed it did not have permission to read. DONT WONT WORK RUINS
SSH.</p>

<p class=MsoNormal>Further note, Windows supports OpenSSH in beta (providing an
SSH service as well as an SSH client) but does not support SSH-copy-id.  </p>

<p class=MsoNormal>&nbsp;</p>

<h1>Deployments</h1>

<p class=MsoNormal>Parallel processing is a mode of operation where the task is
executed concurrently in multiple processors in one or more computers. Parallelization
is meant to reduce the overall processing time. However, there is communication
and synchronization overhead when coordinating parallel processes which can increase
the overall execution time taken for small tasks rather than decreasing it. An
excellent online tutorial explaining parallel computation can be found <a
href="https://computing.llnl.gov/tutorials/parallel_comp/">here</a>. </p>

<p class=MsoNormal>Traditionally, software has been written for serial
computation where the programming is broken into a discrete series of
instructions, the program instructions are executed sequentially one after
another and the execution is on a single processor. Parallel computing is the
simultaneous use of multiple computing resources to solve a computational
problem where  programming problem is broken into discrete parts that can be
solved concurrently, and each part is further broken down to a series of
instructions that execute simultaneously on different processors and requires
an overall control/coordination mechanism to synchronize the parallel
operation. </p>

<p class=MsoNormal>Some definitions should help clarify the parallel concepts. Task
is a logically discrete section of computational work. A task is typically a
program or program-like set of instructions that is executed by a processor. A
parallel program consists of multiple tasks running on multiple processors. Throughput
is a timing measure to evaluate the parallel operation performance. It measures
the amount of completed work against time consumed. Pipeline is an approach to
breaking a task into steps performed by different processor units, with inputs
streaming through, much like an assembly line; a type of parallel computing. Synchronization
applies to either shared data or parallel task is the coordination of processes
or threads, either to avoid conflicts of shared resources or to coordinate
execution. </p>

<p class=MsoNormal>Parallel programs can be executed across cores, processes,
threads, multiple computer on a shared network. Concurrent programming concerns
operations that appear to be parallel but are sharing a computational resource
(one processor) so that multiple tasks share the CPU one-at-a-time during
execution.  Core is an independent computer processing unit (CPU) that read and
execute computer program instructions. A multi-core processor is physically a
single processor with two or more cores. Cores can help parallelize computer
programs to increase throughput.  A process is the instance of a computer
program that is being executed by one or many threads on one or more cores. A
thread is the smallest unit of concurrent task programming that executes within
a process.   A network connects a group of computer systems and other computing
hardware devices using a standard communication channel (International Organization for Standardization, 1989).</p>

<p class=MsoNormal>Modern computers are parallel in architecture with multiple
processors/cores. Parallel software is specifically intended for parallel
hardware with multiple cores, threads, etc. In most cases, serial programs that
run on modern computers &quot;waste&quot; potential computing power.</p>

<p class=MsoNormal>The goal of the hyperparameter optimization task is to use
as much computing power as possible in a parallel operation. The hyperparameter
optimization problem is computing intensive but can be easily parallelized into
distributed hyperparameter evaluation operations. Computing power includes CPU
cores, GPU on the host execution computer as well as remote computing resources
accessible via a network or cloud. </p>

<p class=MsoNormal>&nbsp;</p>

<h2>Python multiprocessing module</h2>

<p class=MsoNormal>Varying success was found with different parallelization
Python packages. The most success was achieved with Ray, so it's use will be
covered.</p>

<h2>RAY</h2>

<p class=MsoNormal>Ray  is a Python module that has  Read the docs documentation
which can be found <a
href="https://ray.readthedocs.io/en/latest/autoscaling.html">here</a>.  The
Berkeley rise lab also has many blog entries on Ray found <a
href="https://rise.cs.berkeley.edu/blog/">here</a>. The blog entry &quot;Programming
in Ray: Tips for first-time users&quot; was especially useful found <a
href="https://rise.cs.berkeley.edu/blog/ray-tips-for-first-time-users/">here</a>.</p>

<h3>Install</h3>

<p class=MsoNormal>Because the ML model used Keras (really TensorFlow ), you
should install the required Python packages as described earlier.  Plus, you must
make the Python interpreter you use match the Ray version you install. This can
be a problem if for example, you installed TensorFlow  for Python 3.6 and Ray
distribution is now Python 3.7. You must watch for mismatch of versions.
Installing older Python interpreter versions is explained in read the docs. </p>

<p class=MsoNormal>The latest version of Ray for Python 3.7 is installed by:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>pip
install -U ray</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>pip
install -U ray [debug]</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>pip
install -U ray [dashboard]</p>

</div>

<p class=MsoNormal>Or you must download a wheel to install, for example, pip
install of the Python 3.6 shown below.</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'> pip
install -U ray -0.6.2-cp36-cp36m-manylinux1_x86_64.whl</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Be careful. Python interpreter subversions must match across
platforms, so 3.7.3 DOES NOT MATCH 3.7.7. You will need to include the correct
subversion on the anaconda virtual environment creations.</p>

<h3>Configuration</h3>

<p class=MsoNormal>The initial Ray cluster involved Linux PC two machines with
the following hardware characteristics:</p>

<table class=MsoTable15Grid4Accent1 border=1 cellspacing=0 cellpadding=0
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=138 valign=top style='width:103.25pt;border:solid #4472C4 1.0pt;
  border-right:none;background:#4472C4;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><b><span style='color:white'>PC: </span></b></p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:solid #4472C4 1.0pt;
  border-left:none;border-bottom:solid #4472C4 1.0pt;border-right:none;
  background:#4472C4;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><b><span style='color:white'>Dell Precision 7720 (07B1)</span></b></p>
  </td>
  <td width=240 valign=top style='width:2.5in;border:solid #4472C4 1.0pt;
  border-left:none;background:#4472C4;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><b><span style='color:white'>Dell Latitude E6530</span></b></p>
  </td>
 </tr>
 <tr>
  <td width=138 valign=top style='width:103.25pt;border:solid #8EAADB 1.0pt;
  border-top:none;background:#D9E2F3;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><b><span style='color:black'>Architecture:&nbsp;</span></b></p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:none;border-left:none;
  border-bottom:solid #8EAADB 1.0pt;border-right:solid #8EAADB 1.0pt;
  background:#D9E2F3;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><span style='color:black'>x86_64</span></p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:none;border-left:none;
  border-bottom:solid #8EAADB 1.0pt;border-right:solid #8EAADB 1.0pt;
  background:#D9E2F3;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><span style='color:black'>x86_64</span></p>
  </td>
 </tr>
 <tr>
  <td width=138 valign=top style='width:103.25pt;border:solid #8EAADB 1.0pt;
  border-top:none;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><b>CPU(s):&nbsp;</b></p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:none;border-left:none;
  border-bottom:solid #8EAADB 1.0pt;border-right:solid #8EAADB 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText>8</p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:none;border-left:none;
  border-bottom:solid #8EAADB 1.0pt;border-right:solid #8EAADB 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText>4</p>
  </td>
 </tr>
 <tr>
  <td width=138 valign=top style='width:103.25pt;border:solid #8EAADB 1.0pt;
  border-top:none;background:#D9E2F3;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><b><span style='color:black'>Thread(s) per core:</span></b></p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:none;border-left:none;
  border-bottom:solid #8EAADB 1.0pt;border-right:solid #8EAADB 1.0pt;
  background:#D9E2F3;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><span style='color:black'> 2</span></p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:none;border-left:none;
  border-bottom:solid #8EAADB 1.0pt;border-right:solid #8EAADB 1.0pt;
  background:#D9E2F3;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><span style='color:black'>2</span></p>
  </td>
 </tr>
 <tr>
  <td width=138 valign=top style='width:103.25pt;border:solid #8EAADB 1.0pt;
  border-top:none;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><b>Core(s) per socket:</b></p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:none;border-left:none;
  border-bottom:solid #8EAADB 1.0pt;border-right:solid #8EAADB 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText> 4</p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:none;border-left:none;
  border-bottom:solid #8EAADB 1.0pt;border-right:solid #8EAADB 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText>2</p>
  </td>
 </tr>
 <tr>
  <td width=138 valign=top style='width:103.25pt;border:solid #8EAADB 1.0pt;
  border-top:none;background:#D9E2F3;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><b><span style='color:black'>Model name:</span></b></p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:none;border-left:none;
  border-bottom:solid #8EAADB 1.0pt;border-right:solid #8EAADB 1.0pt;
  background:#D9E2F3;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><span style='color:black'> Intel(R) Core(TM) i7-7820HQ
  CPU @ 2.90GHz</span></p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:none;border-left:none;
  border-bottom:solid #8EAADB 1.0pt;border-right:solid #8EAADB 1.0pt;
  background:#D9E2F3;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><span style='color:black'>Intel(R) Core(TM) i5-3360M
  CPU @ 2.80GHz</span></p>
  </td>
 </tr>
 <tr>
  <td width=138 valign=top style='width:103.25pt;border:solid #8EAADB 1.0pt;
  border-top:none;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><b>CPU MHz:</b></p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:none;border-left:none;
  border-bottom:solid #8EAADB 1.0pt;border-right:solid #8EAADB 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText> 1692.115</p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:none;border-left:none;
  border-bottom:solid #8EAADB 1.0pt;border-right:solid #8EAADB 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText>1196.138</p>
  </td>
 </tr>
 <tr>
  <td width=138 valign=top style='width:103.25pt;border:solid #8EAADB 1.0pt;
  border-top:none;background:#D9E2F3;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><b><span style='color:black'>OS</span></b></p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:none;border-left:none;
  border-bottom:solid #8EAADB 1.0pt;border-right:solid #8EAADB 1.0pt;
  background:#D9E2F3;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><span style='color:black'>Ubuntu 18.04</span></p>
  </td>
  <td width=240 valign=top style='width:2.5in;border-top:none;border-left:none;
  border-bottom:solid #8EAADB 1.0pt;border-right:solid #8EAADB 1.0pt;
  background:#D9E2F3;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoPlainText><span style='color:black'>Ubuntu 16.04</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Then a YAML configuration file was configured for ad-hoc SSH
cluster containing the two Linux CPU nodes that creates many workers. The file
was modified from the sample provided by Ray's read the docs. Had intermittent
success and failure with the YAML configuration file, so your results may vary.
</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># An
unique identifier for the head node and workers of this cluster.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>cluster_name:
wtfray</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>## NOTE:
Typically for local clusters, min_workers == initial_workers == max_workers.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># The
minimum number of workers nodes to launch in addition to the head # node. This
number should be &gt;= 0.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>#
Typically, min_workers == initial_workers == max_workers.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>min_workers:
10</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># The
initial number of worker nodes to launch in addition to the head node.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>#
Typically, min_workers == initial_workers == max_workers.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>initial_workers:
1</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># The
maximum number of workers nodes to launch in addition to the head node.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># This
takes precedence over min_workers.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>#
Typically, min_workers == initial_workers == max_workers.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>max_workers:
100</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>#
Autoscaling parameters.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Ignore
this if min_workers == initial_workers == max_workers.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>autoscaling_mode:
default</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>target_utilization_fraction:
0.8</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>idle_timeout_minutes:
120</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># This
executes all commands on all nodes in the docker container, # and opens all the
necessary ports to support the Ray cluster.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Empty
string means disabled. Assumes Docker is installed.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>docker:</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    
image: &quot;&quot; # e.g., tensorflow / tensorflow:1.5.0-py3</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    
container_name: &quot;&quot; # e.g. ray_docker</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>     # If
true, pulls latest version of image. Otherwise, `docker run` will only pull the
image</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>     # if
no cached version is present.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    
pull_before_run: True</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    
run_options: []  # Extra options to pass into &quot;docker run&quot;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Local
specific configuration.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>provider:</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    
type: local</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    
head_ip: lightning</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    
worker_ips: [192.168.1.9]</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># How Ray
will authenticate with newly launched nodes.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>auth:</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>     ssh_user:
michalos</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>     ssh_private_key:
~/.ssh/id_rsa</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Leave
this empty.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>head_node:
{</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    
KeyName: ~/.ssh/id_rsa</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>}</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Leave
this empty.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>worker_nodes:
{</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    
KeyName: ~/.ssh/id_rsa</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>}</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Files
or directories to copy to the head and worker nodes. The format is a #
dictionary from REMOTE_PATH: LOCAL_PATH, e.g.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>file_mounts:
{</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>#   
&quot;/path1/on/remote/machine&quot;: &quot;/path1/on/local/machine&quot;, #   
&quot;/path2/on/remote/machine&quot;: &quot;/path2/on/local/machine&quot;, }</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># List of
commands that will be run before `setup_commands`. If docker is # enabled,
these commands will run outside the container and before docker # is setup.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>initialization_commands:
[]</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># List of
shell commands to run to set up each nodes.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>setup_commands:</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>     -
echo 'export PATH=&quot;/usr/local/anaconda3/envs/py37/bin:$PATH&quot;'
&gt;&gt; ~/.bashrc</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>     -
source /usr/local/anaconda3/etc/profile.d/conda.sh; conda activate py37</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>     -
pip install -U ray</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Custom
commands that will be run on the head node after common setup.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>head_setup_commands:
[]</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Custom
commands that will be run on worker nodes after common setup.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>worker_setup_commands:
[]</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Command
to start Ray on the head node. You don't need to change this.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>head_start_
ray _commands:</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>     - ray
stop</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>     -
ulimit -c unlimited &amp;&amp; ray start --head --redis-port=6379
--autoscaling-config=~/ray_bootstrap_config.yaml</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Command
to start Ray on worker nodes. You don't need to change this.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>worker_start_ray_commands:</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>     - ray
stop</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>     - ray
start --address=$RAY_HEAD_IP:6379</p>

</div>

<p class=MsoNormal>One change was to add the SSH private key to the head_node
and the remote_node based on a template I found on the internet. This added
onyx (the worker node) to the cluster. You must have a space after the &quot;:&quot;
delimiter or the Key and Value are combined(!) into one key. You can check what
is happening after reading and interpreting your YAML configuration file, by
examining the file ~/ray_bootstrap_config.yaml. That's how I found this
feature. It's unclear if this even works or helps, but someone on the Internet
did it, and it seemed like a good idea.</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Leave
this empty. DIDN'T!</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>head_node:
{</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    
KeyName: ~/.ssh/id_rsa</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>}</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># Leave
this empty. DIDN'T!</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>worker_nodes:
{</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    
KeyName: ~/.ssh/id_rsa</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>}</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>When the diagnostic messages did spew forth on the command
&quot;Ray up&quot; during the connecting to the worker onyx, it appeared that
it wasn't using the correct Anaconda virtual environment (py37). So various
attempts at different YAML configurations were taken, with no clear success. </p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>setup_commands:</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'> &nbsp;&nbsp;&nbsp;
- echo 'export PATH=&quot;/usr/local/anaconda3/envs/py37/bin:$PATH&quot;'
&gt;&gt; ~/.bashrc</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'> &nbsp;&nbsp;&nbsp;
- source /usr/local/anaconda3/etc/profile.d/conda.sh; conda activate py37</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'> &nbsp;&nbsp;&nbsp;
- pip install -U ray</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>However, manual connecting of the onyx worker to the head
Ray seemed to always work, once the header was underway.</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>ray start
--address='192.168.1.3:6379' --redis-password='5241590000000000'</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<h3>Starting the Ray cluster</h3>

<p class=MsoNormal>The &quot;ray up&quot; command uses a YAML configuration
file to start cluster. In our case the cluster is an ad-hoc SSH network of PCs.</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='background:white'>(py37) michalos@lightning:/usr/local/michalos/Py37$ ray
up ./raytwoconfig.yaml</span></p>

</div>

<p class=MsoNormal>There is a lot of messy diagnostics spewing forth that
follows. For example: quoting <a
href="https://ray.readthedocs.io/en/latest/autoscaling.html">here</a>: &quot;You
may see a message like:  </p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>bash:
cannot set terminal process group (-1): Inappropriate ioctl for device bash: no
job control in this shell This is a harmless error. If the cluster launcher
fails, it is most likely due to some other factor&quot;</p>

</div>

<p class=MsoNormal>Unfortunately, sometimes a worker Linux PC wouldn't join the
Ray cluster, so it was done manually as instructed by the Ray startup
diagnostics.</p>

<p class=MsoNormal>To see if the Ray deployment launch is working, it's best to
use the dashboard by putting the URL  localhost:8265 (or port 8266) into a Web
browser. This action will pop up the Ray dashboard and you should see two PC's
in the cluster, which was the goal, shown below. It may not be eye candy, but
it is very serviceable and understandable.</p>

<p class=MsoNormal><img border=0 width=624 height=282 id="Picture 4"
src="pyparallizing_files/image001.png"></p>

<h3>Example Python Parallel Program</h3>

<p class=MsoNormal>A test program from <a
href="https://medium.com/distributed-computing-with-ray/easy-distributed-scikit-learn-training-with-ray-54ff8b643b33">here</a>
was used to validate that all the nodes in the cluster were being used. There
are lots of Ray test source code found <a
href="https://github.com/ray-project/ray/blob/master/python/ray/tests/test_joblib.py">here</a>
under the github site. Cluster parallelism was done by visually monitoring the
web browser dashboard. </p>

<p class=MsoNormal>A brief overview of the simplicity of using the Scikit learn
joblib backend to parallelize computation across the cluster will be discussed.
The Ray package joblib parallelism approach involved three elements:</p>

<p class=MsoListParagraphCxSpFirst style='text-indent:-.25in'>1)<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp; </span>starting
the head and workers in the cluster on the command line (using ray up), </p>

<p class=MsoListParagraphCxSpLast style='text-indent:-.25in'>2)<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp; </span>importing
the ray module into the Python program, and </p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>import
ray</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>from
ray.util.joblib import register_ray</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>register_ray()</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoListParagraph style='text-indent:-.25in'>3)<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span>using the Ray parallel backend for scikit optimize joblib. </p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>ray.init(address=&quot;192.168.1.3:6379&quot;)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>with
parallel_backend('ray'):</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>   
search.fit(x, y)</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>where 192.168.1.3:6379 was the localhost IP. The details are
not readily apparent, but the Ray cluster worked, given the following versions
of Python interpreter and modules.</p>

<p class=MsoNormal>&nbsp;</p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=186 valign=top style='width:139.25pt;border:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>Module</p>
  </td>
  <td width=180 valign=top style='width:135.0pt;border:solid windowtext 1.0pt;
  border-left:none;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>Version</p>
  </td>
 </tr>
 <tr>
  <td width=186 valign=top style='width:139.25pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>Python interpreter</p>
  </td>
  <td width=180 valign=top style='width:135.0pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>3.7.7</p>
  </td>
 </tr>
 <tr>
  <td width=186 valign=top style='width:139.25pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>conda </p>
  </td>
  <td width=180 valign=top style='width:135.0pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>4.6.11</p>
  </td>
 </tr>
 <tr>
  <td width=186 valign=top style='width:139.25pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>ray</p>
  </td>
  <td width=180 valign=top style='width:135.0pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>0.8.4</p>
  </td>
 </tr>
 <tr>
  <td width=186 valign=top style='width:139.25pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>scikit-learn                                                                  
  </p>
  </td>
  <td width=180 valign=top style='width:135.0pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>0.22.1</p>
  </td>
 </tr>
</table>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Once the two PC cluster was established as working, the
Python interpreters' versions were matched up, life was much smoother, and this
test Ray cluster ran.  Again, it was not trouble free for me, as among problem
encountered, Ray complained of a version mismatch again between the head and
the remote Python interpreter. Rebooting a Linux PC caused its IP to change on
the local home network (due to the pandemic quarantine).</p>

<p class=MsoNormal><b>&nbsp;</b></p>

<h2>&nbsp;</h2>

<h2>Sklearn <a name="_Hlk38963363">GridSearchCV </a>applied to the Optimal Hyperparameters
for the AI/ML Problem</h2>

<p class=MsoNormal>Once it was established that Ray would parallelize on an
ad-hoc SSH cluster properly, it was applied to the AI/ML problem being
researched.  In general, ML models are based on numerous hyperparameters that
can affect the accuracy of the learned model. For a ML model, there is no one
&quot;best&quot; setting for these for all datasets. To get the optimal
accuracy, the hyperparameters need to be tuned for each application and each
dataset. Except for trivial cases, the assignment and evaluation of different
hyperparameter options precludes anything but an automated approach. Yet even
with an automated ML approach, hyperparameter search can be computationally
expensive, especially if you are searching over a large hyperparameter space
and dealing with numerous hyperparameters.</p>

<p class=MsoNormal>Scikit-learn is a Python module integrating a wide range of
machine learning algorithms (Pedregosa, 2011). The intention of Scikit-learn
package is to bring machine learning to non-specialists (scikit-learn.org, 2020). The automated machine learning packages used from sci-kit optimize were:
RandomizedSearchCV, GridSearchCV, and Bayesian Search.   Examples of various
application of sklearn optimization can be found <a
href="https://www.programcreek.com/python/example/91146/sklearn.model_selection.RandomizedSearchCV">here</a>. 
RandomizedSearchCV and GridSearchCV use the same basic template to evaluate the
hyperparameters to find the best set. On the other hand, Scikit-learn Bayesian
Search uses a different template for evaluation. The Scikit-learn  user guide
for  &quot;Tuning the hyper-parameters of an estimator&quot; can be found <a
href="https://scikit-learn.org/stable/modules/grid_search.html#grid-search">here</a>.</p>

<p class=MsoNormal>Scikit-learn does leverage performance opportunities on the
current machine to minimize the computation required of hyperparameter searching.
Scikit-learn exploits concurrency on the current machine by using all the cores
through parallelism using the Python joblib package. Joblib instantiates jobs
that run on multiple CPU cores. The parallelism of these jobs is limited by the
number of CPU cores available on that node.</p>

<p class=MsoNormal>However, Scikit-Learn parallelism is adaptable by just
changing the joblib's backend.  Ray's implementation of a joblib's backend
parallelism allows a GridSearchCV  program to train and evaluate all the ML
model using all the cores of a cluster. Ray handles all the difficult
parallelism program allowing  a GridSearchCV  distributed application to run on
multiple nodes by handling the scheduling of ML evaluation tasks across
multiple machines.  To use GridSearchCV   joblib parallelism, we use an informally
managed networks of machines using SSH as configured for Ray earlier.</p>

<p class=MsoNormal>Below is the primary of GridSearchCV application to the
KerasRegressor ML model hyperparameters. </p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>def
main(argv):</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>   
global config</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>   
x_train, y_train, x_test, y_test =
datagen.readDataFile(config[&quot;model_dir&quot;] + '/kindata.csv',
verbose=True)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>   
params = dict(activation=['relu', 'linear'],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>                 
optimizer=['adam', 'adagrad', 'nadam'],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>                 
batch_size=[1, 128, 1024, datagen.numrows],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>                 
numneurons=[10, 64, 1024],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>                 
numlayers=[5, 20, 100],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>                 
learningrate=[0.01, 0.001],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>                 
epochs=[5, 10, 50, 100],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>                 
)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>   
regressor = tf.keras.wrappers.scikit_learn.KerasRegressor \</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>       
(build_fn=baseline_model,</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        
batch_size=numrows,</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        
epochs=epochs,</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        
verbose=1</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        
)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    #
https://medium.com/swlh/hyper-parameter-tuning-for-keras-models-with-scikit-learn-library-dba47cf41551</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    rscv
= GridSearchCV(regressor,</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>                       
param_grid=params,</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>                       
refit=True,</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>                       
cv=3,</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>                       
verbose=2)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    #
Train model using randomized hyperparameter values</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    start
= time.time()</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    ray.init(address=&quot;192.168.1.3:6379&quot;)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    with
parallel_backend('Ray'):  # added line.</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>       
rscv_results = rscv.fit(x_train, y_train)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    end =
time.time()</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>   
elapsed = end - start</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>   
hours, rem = divmod(end - start, 3600)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>   
minutes, seconds = divmod(rem, 60)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    print(</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>       
&quot;optimization time&quot; + &quot;Prediction time =
{:0&gt;2}:{:0&gt;2}:{:07.4f}&quot;.format(int(hours), int(minutes), seconds))</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    print
('Best score ' + str(rscv_results.best_score_))</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    print
('best option' + str(rscv_results.best_params_))</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    print
('All options ' + str(params))</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Of note, typical metrics useful in classification ML model, i.e.,
accuracy, precision, etc., are not useful in regression ML models. More in
depth discussion on metrics as applied to different ML models can be found <a
href="https://towardsdatascience.com/20-popular-machine-learning-metrics-part-1-classification-regression-evaluation-metrics-1ca3e282a2ce">here</a>.</p>

<p class=MsoNormal>Overall embedded inside the KerasRegressor model is the
compilation for the metrics as:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>model.compile(optimizer=optfcn,
loss=lossfcn, metrics=[r_square, rmse])</p>

</div>

<pre style='background:white'><i><span style='font-family:"JetBrains Mono",serif;
color:#8C8C8C'>&nbsp;</span></i></pre>

<p class=MsoNormal>Below is code that corresponds to the custom metric
functions r_square, rmse, and mse:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># root
mean squared error (rmse) for regression (only for Keras tensors)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#0033B3'>def </span>rmse<span style='color:#080808'>(y_true,
y_pred):</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#080808'>    </span><span style='color:#0033B3'>return </span><span
style='color:#080808'>K.sqrt(K.mean(K.square(y_pred - y_true), </span><span
style='color:#660099'>axis</span><span style='color:#080808'>=-</span><span
style='color:#1750EB'>1</span><span style='color:#080808'>))</span></p>

</div>

<pre style='background:white'><span style='font-family:"JetBrains Mono",serif;
color:#080808'>&nbsp;</span></pre>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'># mean
squared error (mse) for regression  (only for Keras tensors)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#0033B3'>def </span>mse<span style='color:#080808'>(y_true,
y_pred):</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#080808'>    </span><span style='color:#0033B3'>return </span><span
style='color:#080808'>K.mean(K.square(y_pred - y_true), </span><span
style='color:#660099'>axis</span><span style='color:#080808'>=-</span><span
style='color:#1750EB'>1</span><span style='color:#080808'>)</span></p>

</div>

<pre style='background:white'><span style='font-family:"JetBrains Mono",serif;
color:#080808'>&nbsp;</span></pre><pre style='background:white'><span
style='font-family:"JetBrains Mono",serif;color:#080808'>&nbsp;</span></pre>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>#
coefficient of determination (R^2) for regression  (only for Keras tensors)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#0033B3'>def </span>r_square<span style='color:#080808'>(y_true,
y_pred):</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#080808'>    SS_res = K.sum(K.square(y_true - y_pred))</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#080808'>    SS_tot = K.sum(K.square(y_true - K.mean(y_true)))</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#080808'>    </span><span style='color:#0033B3'>return </span><span
style='color:#080808'>(</span><span style='color:#1750EB'>1 </span><span
style='color:#080808'>- SS_res / (SS_tot + K.epsilon()))</span></p>

</div>

<pre style='background:white'><span style='font-family:"JetBrains Mono",serif;
color:#080808'>&nbsp;</span></pre><pre style='background:white'><span
style='font-family:"JetBrains Mono",serif;color:#080808'>&nbsp;</span></pre><pre
style='background:white'><span style='font-family:"JetBrains Mono",serif;
color:#080808'>&nbsp;</span></pre>

<p class=MsoNormal>&nbsp;</p>

<h2>Observations</h2>

<p class=MsoNormal>In the test local home network (during pandemic quarantine),
the Linux worker IP changed! This will wreak havoc and wasted valuable time.  </p>

<p class=MsoNormal>For a novice, one of the major annoyances using sklearn Grid
and Random Hyperparameter search in general is being clueless on the time until
completion. This oblivious is especially annoying as there is no checkpoint
mechanism to stop/resume a sklearn hyperparameter search so once the search is
underway you have to wait until done or abort the search.  For a ML model with
21 different options, this corresponds to 5 E19 combinations, which   </p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<h3>Addition Ray Packages</h3>

<p class=MsoNormal>Ray provides other Python libraries to scale applications,
including Tune, a scalable hyperparameter tuning library and RLlib, a scalable
reinforcement learning library. </p>

<p class=MsoNormal>Ray Tune-sklearn  is a package that integrates Ray Tune's
hyperparameter tuning and scikit-learn's models, allowing users to optimize
hyerparameter searching for sklearn using Tune's schedulers (more details found
<a href="https://github.com/ray-project/tune-sklearn">here</a>). Tune-sklearn
provides additional benefits if specifying a scheduler with an estimator that <b>supports
early stopping</b>. The list of estimators that can be supported from
scikit-learn can be found in scikit-learn's documentation found <a
href="https://scikit-learn.org/stable/modules/computing.html#strategies-to-scale-computationally-bigger-data">here</a>
</p>

<p class=MsoNormal>Using Tune, Ray supports distributed TensorFlow  for ML
modeling, which can be found <a
href="https://docs.ray.io/en/latest/raysgd/raysgd_tensorflow.html">here</a>.
However, at this time no application was attempted. In addition, Ray also has
module support for PyTorch, also uninvestigated currently.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<h1>FAQ</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span class=MsoBookTitle>Q: Why GridSearchCV and why not
hyperopt?</span></p>

<p class=MsoNormal>Based on the Python parallelization packages available (ray
and dask especially), GridSearchCV joblib was used as a first step in parallelizing
the hyperparameter optimization for clusters locally and on the cloud.  </p>

<p class=MsoNormal>A hyperopt parallelization module with examples is available
on github and found <a href="https://github.com/hyperopt/hyperopt">here</a>.  This
library uses Apache spark to parallelize. Although intriguing, this has not
been tested at this point in time.</p>

<p class=MsoNormal><span class=MsoBookTitle>Q: My remote host has anaconda3 in
wrong pat, how do I fix this?</span></p>

<p class=MsoNormal>You might as get over it and always load anaconda into
/usr/local/anaconda3. This brings a few challenges as usr locl is
administrative privileged, but first, you should just remove existing anaconda
and conda packages that are installed under you home directory, and reinstall
under /usr/local. To remove the existing anaconda installation, do the
following.</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>conda
install anaconda-clean</p>

</div>

<p class=MsoNormal>Remove all Anaconda-related files and directories without
being prompted to delete each one:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>anaconda-clean
yes</p>

</div>

<p class=MsoNormal>Open a terminal window, and then remove your entire Anaconda
directory, which has a name such as anaconda3</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>rm&nbsp;-rf&nbsp;~/anaconda3.</p>

</div>

<p class=MsoNormal>Removing Anaconda path from .bash_profile</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>export
PATH=&quot;/Users/xxx/anaconda3/bin:$PATH&quot;</p>

</div>

<p class=MsoNormal>Replace /Users/xxx/anaconda3/ with your actual path.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span class=MsoBookTitle>Q: What is the easiest way to load
anaconda into /usr/local folder?</span></p>

<p class=MsoNormal>I suggest the following, which may not be the easiest.</p>

<p class=MsoNormal>You can install the anaconda distribution but load it into
/usr/local/anaconda3 and then change the ownership of all the files and folders
under anaconda3 to you. For example:</p>

<p class=MsoNormal><span class=MsoBookTitle>Q: How do I downgrade Ray
installation to support Python 3.6 ?</span></p>

<p class=MsoNormal>Combination of uninstall, download and scp copy of Ray for
python 3.6 wheel to onyx, </p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>cd
/usr/local</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>sudo
chown -R michalos anaconda3</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='background:white'>(gzrcsplugin_env) michalos@lightning:~/Downloads$ scp</span><br>
<span style='background:white'>./ray-0.6.2-cp36-cp36m-manylinux1_x86_64.whl
michalos@onyx:/home/michalos</span></p>

</div>

<p class=MsoNormal><span style='color:black;background:white'>On remote machine
(onyx) bring up terminal, run</span></p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='background:white'>(gzrcsplugin_env): source activate gzrcsplugin_env</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='background:white'>(gzrcsplugin_env): pip uninstall </span>ray<br>
<span style='background:white'>(gzrcsplugin_env): pip uninstall </span>ray<span
style='background:white'> [debug]</span><br>
<span style='background:white'>(gzrcsplugin_env): pip uninstall </span>ray<span
style='background:white'> [dashboard]</span><br>
<span style='background:white'>(gzrcsplugin_env): pip install -U </span>ray<span
style='background:white'> -0.6.2-cp36-cp36m-manylinux1_x86_64.whl</span></p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span class=MsoBookTitle>Q: How do you change the python
version in Anaconda virtual environment?</span></p>

<p class=MsoNormal>Ray complained that a local and a remote host had different subversions
of the Python interpreter, i.e.,</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>RuntimeError:
Version mismatch: The cluster was started with:</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    Ray:
0.8.4</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>   
Python: 3.7.3</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>This
process on node 192.168.1.13 was started with:</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    Ray:
0.8.4</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>   
Python: 3.7.7</p>

</div>

<p class=MsoNormal>A quick change is to set the anaconda virtual environment
and then install the desired python version. Anaconda will do the removal of
the old python interpreter and the install of the new version:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>(py37) $
source activate py37</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>(py37) $ conda
install python=3.7.3</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>. . .</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>The
following packages will be DOWNGRADED:</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'> 
python                           3.7.7-hcf32534_0_cpython --&gt;
3.7.3-h0371630_0</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'> 
readline                                   8.0-h7b6447c_0 --&gt; 7.0-h7b6447c_5</p>

</div>

<p class=MsoNormal>You can verify with the following terminal code:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>(py37) $
`which python` --version</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>Python
3.7.3</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span class=MsoBookTitle>Q: Verified firewall not running on
either cluster machine</span></p>

<p class=MsoNormal>Running the Ray parallelization library, you may see this
warning.</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>If you
have trouble connecting from a different machine, check that your firewall is
configured properly.</p>

</div>

<p class=MsoNormal>Assuming you have ufw (uncomplicated firewall) installed on
Ubuntu, you can check if it is running:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='background:white'>(py37) $ sudo ufw status</span><br>
<span style='background:white'>[sudo] password for michalos:</span><br>
<span style='background:white'>Status: inactive</span></p>

</div>

<p class=MsoNormal>If its active you would need to open the appropriate ports
for host, dashboard, workers, etc. This is application dependent.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span class=MsoBookTitle>Q: What version of Python is the
default interpreter when logging in?</span></p>

<p class=MsoNormal>Because ROS is installed and need Python 2.7 it is the
default Python interpreter. This is a pain. Here is how to remotely tell what
version of Python is the default interpreter when logging in (using ssh):</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;  ssh
michalos@onyx python version</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>2.7</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&gt;  ssh
michalos@onyx source activate py37; python version</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>3.7</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span class=MsoBookTitle>Q: How many grid combinations are there
for a list or params? </span></p>

<p class=MsoNormal>Assume your Hyperparameter grid contains the following
options.</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>params = <span
style='color:navy'>dict</span>(<span style='color:#660099'>activation</span>=[<b><span
style='font-family:"inherit",serif;color:teal'>'relu'</span></b>, <b><span
style='font-family:"inherit",serif;color:teal'>'linear'</span></b>],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>             
<span style='color:#660099'>optimizer</span>=[<b><span style='font-family:"inherit",serif;
color:teal'>'adam'</span></b>, <b><span style='font-family:"inherit",serif;
color:teal'>'adagrad'</span></b>, <b><span style='font-family:"inherit",serif;
color:teal'>'nadam'</span></b>],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>             
<span style='color:#660099'>batch_size</span>=[<span style='color:#1750EB'>1</span>,
<span style='color:#1750EB'>128</span>, <span style='color:#1750EB'>1024</span>,
numrows],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>             
<span style='color:#660099'>numneurons</span>=[<span style='color:#1750EB'>10</span>,
<span style='color:#1750EB'>64</span>, <span style='color:#1750EB'>1024</span>],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>             
<span style='color:#660099'>numlayers</span>=[<span style='color:#1750EB'>5</span>,
<span style='color:#1750EB'>20</span>, <span style='color:#1750EB'>100</span>],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>             
<span style='color:#660099'>learningrate</span>=[<span style='color:#1750EB'>0.001</span>],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>             
<span style='color:#660099'>epochs</span>=[<span style='color:#1750EB'>10</span>,
<span style='color:#1750EB'>50</span>, <span style='color:#1750EB'>100</span>],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>             
<span style='color:#660099'>lossfcn</span>=[<b><span style='font-family:"inherit",serif;
color:teal'>'mean_squared_error'</span></b>],</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>             
)</p>

</div>

<p class=MsoNormal>For each dictionary list element, the number of possible combinations
is the number of elements N. So for two dictionary list elements, it is an AND
of the two elements, which corresponds to a multiplication, e.g., N1xN2</p>

<p class=MsoNormal>The number of combinations corresponds to the multiplication
of the number of elements in each dictionary list element, i.e.,
2x3x4x3x3x1x3x1=648 alternative hyperparameter options. You can double check
this number of combinations using scikit learn (sklearn) ParameterGrid class
which constructs a list of alternatives from the given param dictionary list.</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    grid
= ParameterGrid(params)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    n = <span
style='color:navy'>len</span>(grid)</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Assuming 648 models using all the hyperparameter fits, and
assuming each ML model train takes 10 minutes, this correspond to 648x10/1440 =
4.5 days of evaluation on a single processor. If you add just 2 cross
validation evaluations, that is fitting with different combination of the
training data,  you know would take 9 days.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span class=MsoBookTitle>Q: How do I monitor progress of a
GridSearchCV?</span></p>

<p class=MsoNormal>The exists a GridSearchCV  progress bar found <a
href="https://pactools.github.io/auto_examples/plot_grid_search.html?highlight=gridsearchcvprogressbar">here</a>.
It was not tested using a Parallel Cluster. Various parallelization Python
packages incorporate progress as part of their </p>

<p class=MsoNormal>During the KerasRegressor fit, a series of a callbacks are
invoked whenever a state has occurred (start train, start epoch, end train, end
epoch, etc.) A class can inherit and override functions of the Keras callback
class to monitor progress. A simple </p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#0033B3'>class </span>MLCallbacks(tf.keras.callbacks.Callback):</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>   
counter = <span style='color:#1750EB'>0</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#1750EB'>&nbsp;</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#1750EB'>    </span><span style='color:#0033B3'>def </span><span
style='color:#B200B2'>__init__</span>(<span style='color:#94558D'>self</span>,
*args, **kwargs):</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <span
style='color:navy'>super</span>(tf.keras.callbacks.Callback, <span
style='color:#94558D'>self</span>).<span style='color:#B200B2'>__init__</span>(*args,
**kwargs)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <span
style='color:#94558D'>self</span>.increment()</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <span
style='color:#94558D'>self</span>.start = time.time()</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <span
style='color:#94558D'>self</span>.stats = []</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    <span
style='color:#0000B2'>@staticmethod</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#0000B2'>    </span><span style='color:#0033B3'>def </span>increment():</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>       
MLCallbacks.counter += <span style='color:#1750EB'>1</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#1750EB'>&nbsp;</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#1750EB'>    </span><span style='color:#0000B2'>@staticmethod</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
style='color:#0000B2'>    </span><span style='color:#0033B3'>def </span>count():</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <span
style='color:#0033B3'>return </span>MLCallbacks.counter</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    <span
style='color:#0033B3'>def </span>on_train_end(<span style='color:#94558D'>self</span>,
logs={}):</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <span
style='color:#94558D'>self</span>.stats.append(<span style='color:navy'>str</span>(<span
style='color:#94558D'>self</span>.count()))</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>       
end = time.time()</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <span
style='color:gray'>elapsed </span>= end - <span style='color:#94558D'>self</span>.start</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>       
hours, rem = <span style='color:navy'>divmod</span>(end - <span
style='color:#94558D'>self</span>.start, <span style='color:#1750EB'>3600</span>)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>       
minutes, seconds = <span style='color:navy'>divmod</span>(rem, <span
style='color:#1750EB'>60</span>)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <span
style='color:#94558D'>self</span>.stats.append(<b><span style='color:teal'>&quot;{:0&gt;2}:{:0&gt;2}:{:07.4f}&quot;</span></b>.format(<span
style='color:navy'>int</span>(hours), <span style='color:navy'>int</span>(minutes),
seconds))</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <span
style='color:#94558D'>self</span>.stats.append(<span style='color:#94558D'>self</span>.model.optimizer.__class__.<span
style='color:#B200B2'>__name__</span>)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <i><span
style='color:#8C8C8C'># self.stats.append(str(self.params['activation']))</span></i></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><i><span
style='color:#8C8C8C'>        </span></i><span style='color:#94558D'>self</span>.stats.append(<span
style='color:navy'>str</span>(<span style='color:#94558D'>self</span>.params[<b><span
style='color:teal'>'batch_size'</span></b>]))</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <span
style='color:#94558D'>self</span>.stats.append(<span style='color:navy'>str</span>(<span
style='color:#94558D'>self</span>.model.layers[<span style='color:#1750EB'>1</span>].units))</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <span
style='color:#94558D'>self</span>.stats.append(<span style='color:navy'>str</span>(<span
style='color:navy'>len</span>(<span style='color:#94558D'>self</span>.model.trainable_weights)
- <span style='color:#1750EB'>2</span>))</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <i><span
style='color:#8C8C8C'># self.stats.append(str(self.params['learningrate']))</span></i></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><i><span
style='color:#8C8C8C'>        </span></i><span style='color:#94558D'>self</span>.stats.append(<span
style='color:navy'>str</span>(<b><span style='color:teal'>' '</span></b>.join(<span
style='color:#94558D'>self</span>.params[<b><span style='color:teal'>'metrics'</span></b>])))</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <span
style='color:#94558D'>self</span>.stats.append(<span style='color:navy'>str</span>(<span
style='color:#94558D'>self</span>.params[<b><span style='color:teal'>'epochs'</span></b>]))</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <span
style='color:#94558D'>self</span>.stats.append(<span style='color:navy'>str</span>(<span
style='color:#94558D'>self</span>.model.loss))</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>        <span
style='color:#94558D'>self</span>.stats.append(<span style='color:navy'>str</span>(statistics.mean(<span
style='color:#94558D'>self</span>.model.history.history[<b><span
style='color:teal'>'loss'</span></b>])))</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><i><span
style='color:#8C8C8C'>        </span></i><span style='color:navy'>print</span>(<b><span
style='color:teal'>','</span></b>.join(<span style='color:#94558D'>self</span>.stats)
+ <b><span style='color:teal'>'</span></b><span style='color:#0037A6'>\n</span><b><span
style='color:teal'>'</span></b>)</p>

</div>

<pre style='background:white'><i><span style='font-family:"JetBrains Mono",serif;
color:#8C8C8C'>&nbsp;</span></i></pre><pre style='background:white'><i><span
style='font-family:"JetBrains Mono",serif;color:#8C8C8C'>&nbsp;</span></i></pre><pre
style='background:white'><i><span style='font-family:"JetBrains Mono",serif;
color:#8C8C8C'>&nbsp;</span></i></pre><pre style='background:white'><span
style='font-family:"JetBrains Mono",serif;color:#080808'>Later the callback is inserted into the argument list for the fit function:</span></pre>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>rscv_results
= rscv.fit(x_train, y_train, <span style='color:#660099'>callbacks</span>=[MLCallbacks()])</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Note, a threading lock was added to the  custom callback but
resulted in Ray cluster penalization reporting this error:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>TypeError:
can't pickle _thread.lock objects Remove threading lock from Callback.</p>

</div>

<p class=MsoPlainText>&nbsp;</p>

<p class=MsoPlainText>One omission of hyperparameter is the Activation
function, e.g., &quot;relu&quot;. However, this hyperparameters is not easily
accessible to novices (although we tried) and you should start <a
href="https://github.com/philipperemy/keract">here</a>.</p>

<p class=MsoPlainText>&nbsp;</p>

<p class=MsoPlainText>Further, indexing of the callback using a cluster
involves multi-cloning the GridSearchCV process which renders the callback
class to be &quot;unique&quot; on each running process so the index is only
incremented on the local process. Index generation by matching the current
model against the total grid search space was considered, but not undertaken. </p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span class=MsoBookTitle>Q: What does the GridSearchCV refit
parameter mean?</span></p>

<p class=MsoNormal>From <a
href="https://datascience.stackexchange.com/questions/45810/what-is-gridsearchcv-doing-after-it-finishes-evaluating-the-performance-of-param">here</a>
:  The answer is that by default GridSearchCV's last act is to expose the API
of the estimator object you passed so that you can directly call things like
predict() or score() on the GridSearchCV object itself. It does this by
retraining the estimator against the best parameters it found during cross
validation. If you want to skip this step (because, for example, you're going
to go on to do more development or cross-validation afterwards) then you can
pass refit=False to prevent that from happening.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span class=MsoBookTitle>Q: How do I do Scikit Learn
GridSearchCV without cross validation (e.g., unsupervised learning) </span></p>

<p class=MsoNormal>Cross-validation (CV) is a technique for evaluating ML
models by training several ML models on subsets of the available input data and
evaluating them on the complementary subset of the data.  The main reason CV is
used is to prevent overfitting. Timing can be a consideration when using CV. For
instance, if every training fit takes 10 minutes and you have a 6 fold
cross-validation, it will take an hour to evaluate one ML model. As 
overfitting does not appear to be a concern and hyperparameter fitting takes
4.5 days per train,  CV equal to one was desired to reduce the computational
complexity.</p>

<p class=MsoNormal>From <a
href="https://stackoverflow.com/questions/44636370/scikit-learn-gridsearchcv-without-cross-validation-unsupervised-learning">here</a>
: It appears that you can get rid of cross validation in GridSearchCV if you
use:</p>

<p class=MsoNormal>cv=[(slice(None), slice(None))]</p>

<p class=MsoNormal>I have tested this against my own coded version of grid
search without cross validation and I get the same results from both methods. I
am posting this answer to my own question in case others have the same issue.</p>

<p class=MsoNormal>&nbsp;</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>cv =
[(slice(None), slice(None))]</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>gs =
GridSearchCV(estimator=sklearn.cluster.MeanShift(), param_grid=param_dict, </p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>                 
scoring=cv_silhouette_scorer, cv=cv, n_jobs=-1)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>gs.fit(df[cols_of_interest])</p>

</div>

<p class=MsoNormal>Cross-validation is a technique for evaluating ML models by
training several ML models on subsets of the available input data and
evaluating them on the complementary subset of the data.  Now there will be
only one fold:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>Fitting 1
folds for each of 432 candidates, totalling 432 fits</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>The default is 5 cross validation ML model runs, which can
be quite time intensive (if each run is 10 minutes for example.) You can just
make cv=2. But this seems to work.</p>

<p class=MsoNormal><span class=MsoBookTitle>Q: How do I find learning rate in
an optimizer using callback in Keras?</span></p>

<p class=MsoNormal>From <a
href="https://www.tensorflow.org/guide/keras/custom_callback">here</a>: </p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
class=pln>&nbsp; &nbsp; </span><span class=kwd>if</span><span class=pln> </span><span
class=kwd>not</span><span class=pln> hasattr</span><span class=pun>(</span><span
class=kwd>self</span><span class=pun>.</span><span class=pln>model</span><span
class=pun>.</span><span class=pln>optimizer</span><span class=pun>,</span><span
class=pln> </span><span class=str>'lr'</span><span class=pun>):</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
class=pln>&nbsp; &nbsp; &nbsp; </span><span class=kwd>raise</span><span
class=pln> </span><span class=typ>ValueError</span><span class=pun>(</span><span
class=str>'Optimizer must have a &quot;lr&quot; attribute.'</span><span
class=pun>)</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
class=pln>&nbsp; &nbsp; </span><span class=com># Get the current learning rate
from model's optimizer.</span></p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'><span
class=pln>&nbsp; &nbsp; lr </span><span class=pun>=</span><span class=pln> </span><span
class=kwd>float</span><span class=pun>(</span><span class=pln>tf</span><span
class=pun>.</span><span class=pln>keras</span><span class=pun>.</span><span
class=pln>backend</span><span class=pun>.</span><span class=pln>get_value</span><span
class=pun>(</span><span class=kwd>self</span><span class=pun>.</span><span
class=pln>model</span><span class=pun>.</span><span class=pln>optimizer</span><span
class=pun>.</span><span class=pln>lr</span><span class=pun>))</span></p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>How can I monitor progress using Tensorboard</p>

<p class=MsoNormal>Make sure installed.</p>

<p class=MsoNormal>From <a
href="https://www.tensorflow.org/tensorboard/get_started">here</a> :</p>

<p class=MsoNormal>Set up the code to create a tensorboard callback during the
model fit.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>#
Tensorboard logging setup  empty directory if existsd</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>if(os.path.exists(config[&quot;model_dir&quot;]+&quot;logs/fit/&quot;)):</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    
shutil.rmtree(checkpoint_dir)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>     os.makedirs(checkpoint_dir)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'> log_dir
= config[&quot;model_dir&quot;]+&quot;logs/fit/&quot; +
datetime.now().strftime(&quot;%Y%m%d-%H%M%S&quot;)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'> tensorboard_callback
= tf.keras.callbacks.TensorBoard(log_dir=log_dir, histogram_freq=1)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>. . .</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'> rscv_results
= rscv.fit(x_train, y_train,</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>                       
 callbacks=[MLCallbacks(),tensorboard_callback])</p>

</div>

<p class=MsoNormal>Then from a terminal command line start the tensorboard web server:</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>$
tensorboard --logdir logs/fit</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>Serving
TensorBoard on localhost; to expose to the network, use a proxy or pass
--bind_all TensorBoard 2.1.0 at <a href="http://localhost:6006/">http://localhost:6006/</a>
(Press CTRL+C to quit)</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>And bring up a web browser using the URL provided</p>

<p class=MsoNormal><img border=0 width=624 height=398
src="pyparallizing_files/image002.png"></p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span class=MsoBookTitle>Q: Are there any other ML
regression functions that are useful:</span></p>

<p class=MsoNormal>Keras has the following loss functions:</p>

<p class=MsoPlainText style='margin-left:.5in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span> mean_squared_error ,  mean_absolute_error ,&nbsp; 
mean_squared_logarithmic_error ,  squared_hinge ,  hinge ,  logcosh , 
categorical_crossentropy ,  poisson ,  cosine_proximity </p>

<p class=MsoPlainText>&nbsp;</p>

<p class=MsoPlainText>The tutorial <a
href="https://heartbeat.fritz.ai/5-regression-loss-functions-all-machine-learners-should-know-4fb140e9d4b0">here</a>
states that the following loss functions are useful for regression ML:</p>

<p class=MsoPlainText style='margin-left:.5in;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>mean squared error, mean absolute error, huber loss, logcosh
loss, quantile loss</p>

<p class=MsoNormal> </p>

<p class=MsoNormal>You can wrap TensorFlow 's tf.losses.huber_loss in a custom
Keras loss function and then pass it to your model.</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>def
get_huber_loss_fn(**huber_loss_kwargs):</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    def
custom_huber_loss(y_true, y_pred):</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>       
return tf.losses.huber_loss(y_true, y_pred, **huber_loss_kwargs)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>   
return custom_huber_loss</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>&nbsp;</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>#
Later...</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>model.compile(</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>   
loss=get_huber_loss_fn(delta=0.1)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>    ...</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>)</p>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Quantile loss is explained <a
href="https://www.kdnuggets.com/2018/07/deep-quantile-regression.html">here</a>.</p>

<p class=MsoNormal><span class=MsoBookTitle>Q: Find the Activation function in
callback from Keras?</span></p>

<p class=MsoNormal>Most other hyperparameters are explicitly part of the model
creation, however, the activation function is related to weights in the
TensorFlow graph. You will need the keract Python package from Keras creator to
decipher the activation functions for each layer in the DNN.</p>

<div style='border:solid #2F6FAB 1.0pt;padding:12.0pt 12.0pt 12.0pt 9.0pt;
background:#F9F9F9'>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>(py37)
michalos@lightning:/usr/local/michalos/AI/Py37$ pip install keract Collecting
keract</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'> &nbsp;
Downloading keract-3.1.0-py3-none-any.whl (9.7 kB) Requirement already
satisfied: numpy&gt;=1.16.2 in
/usr/local/anaconda3/envs/py37/lib/python3.7/site-packages (from keract)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>(1.18.1)</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>Installing
collected packages: keract</p>

<p class=BoxedCode style='background:#F9F9F9;border:none;padding:0in'>Successfully
installed keract-3.1.0</p>

</div>

<p class=MsoPlainText>&nbsp;</p>

<p class=MsoPlainText>&nbsp;</p>

<pre style='background:white'><span style='font-family:"JetBrains Mono",serif;
color:#080808'>&nbsp;</span></pre>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Notes on running on Enki </p>

<p class=MsoNormal><a
href="https://stackoverflow.com/questions/38601026/easy-way-to-use-parallel-options-of-scikit-learn-functions-on-hpc">https://stackoverflow.com/questions/38601026/easy-way-to-use-parallel-options-of-scikit-learn-functions-on-hpc</a></p>

<p class=MsoNormal>&nbsp;</p>

</div>

</body>

</html>
